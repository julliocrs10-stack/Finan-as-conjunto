<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finan√ßas Fam√≠lia Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1077/1077976.png">
    <meta name="apple-mobile-web-app-title" content="Finan√ßas">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root { --primary: #3b82f6; --success: #10b981; --danger: #f43f5e; --warning: #f59e0b; --bg: #0f172a; --card: #1e293b; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background: var(--bg); color: #fff; height: 100vh; overflow: hidden; }

        .app-container { display: flex; height: 100vh; width: 100vw; flex-direction: column; }
        .content { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px; }

        /* Dashboard Cards */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .card { background: var(--card); padding: 15px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.05); position: relative; }
        .card span { font-size: 11px; color: #94a3b8; text-transform: uppercase; }
        .card h2 { font-size: 18px; margin-top: 4px; }

        /* Nav */
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: var(--card); height: 75px; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; z-index: 100; }
        .nav-item { background: none; border: none; color: #64748b; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; font-size: 12px; }
        .nav-item.active { color: var(--primary); }
        .nav-item i { font-size: 20px; }

        /* Tabs */
        .tab { display: none; }
        .tab.active { display: block; animation: fadeIn 0.3s; }

        /* --- CORES DAS CATEGORIAS (Adicionadas Novas) --- */
        .cat-tag { display: flex; align-items: center; gap: 5px; font-size: 10px; padding: 2px 8px; border-radius: 20px; margin-top: 5px; width: fit-content; }
        
        .cat-alimentacao { background: rgba(245, 158, 11, 0.2); color: #f59e0b; } /* Laranja */
        .cat-moradia { background: rgba(59, 130, 246, 0.2); color: #3b82f6; } /* Azul */
        .cat-transporte { background: rgba(16, 185, 129, 0.2); color: #10b981; } /* Verde */
        .cat-lazer { background: rgba(236, 72, 153, 0.2); color: #ec4899; } /* Rosa */
        .cat-saude { background: rgba(244, 63, 94, 0.2); color: #f43f5e; } /* Vermelho */
        
        /* Novas Categorias */
        .cat-contas { background: rgba(239, 68, 68, 0.2); color: #ef4444; } /* Vermelho Vivo */
        .cat-investimento { background: rgba(139, 92, 246, 0.2); color: #8b5cf6; } /* Roxo */
        .cat-uber { background: rgba(148, 163, 184, 0.2); color: #94a3b8; } /* Cinza/Preto */
        .cat-bonus { background: rgba(250, 204, 21, 0.2); color: #facc15; } /* Ouro */
        .cat-outros { background: rgba(71, 85, 105, 0.2); color: #cbd5e1; }

        /* Metrics List */
        .metric-item { display: flex; justify-content: space-between; align-items: center; font-size: 12px; margin-bottom: 8px; color: #94a3b8; }
        .metric-bar { height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; flex: 1; margin: 0 10px; overflow: hidden; }
        .metric-fill { height: 100%; background: var(--primary); }

        /* Inputs */
        .input-group { margin-bottom: 15px; }
        input, select { width: 100%; padding: 12px; background: #0f172a; border: 1px solid #334155; border-radius: 12px; color: #fff; font-size: 16px; }
        .btn { width: 100%; padding: 15px; background: var(--primary); border: none; border-radius: 15px; color: #fff; font-weight: 600; cursor: pointer; }
        .filter-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="app-container">
        <main class="content">
            
            <section id="home" class="tab active">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3>In√≠cio</h3>
                    <div class="card" style="padding: 5px 15px; border-radius: 10px;">
                        <span style="font-size:9px;">Score</span>
                        <h4 id="score-val" style="color:var(--primary)">0</h4>
                    </div>
                </div>

                <div class="grid">
                    <div class="card" style="grid-column: span 2; background: linear-gradient(135deg, #3b82f6, #2563eb);">
                        <span>Saldo Dispon√≠vel</span><h2 id="bal-total">R$ 0,00</h2>
                    </div>
                    <div class="card"><span>Entradas</span><h2 id="bal-rec" style="color:var(--success)">R$ 0,00</h2></div>
                    <div class="card"><span>Sa√≠das</span><h2 id="bal-des" style="color:var(--danger)">R$ 0,00</h2></div>
                </div>

                <div class="card" style="margin-bottom: 20px;">
                    <span>Gastos por Categoria (%)</span>
                    <div id="metrics-container" style="margin-top:15px;"></div>
                </div>

                <h4>Hist√≥rico Recente</h4>
                <div id="lista-transacoes"></div>
            </section>

            <section id="add" class="tab">
                <h3 id="form-title">Novo Lan√ßamento</h3><br>
                <div class="card">
                    <form id="finance-form">
                        <input type="hidden" id="edit-id">
                        <div class="input-group"><label>O que foi?</label><input type="text" id="desc" required></div>
                        <div class="input-group"><label>Quanto? (R$)</label><input type="number" step="0.01" id="valor" required></div>
                        <div class="input-group">
                            <label>Tipo</label>
                            <select id="tipo">
                                <option value="despesa">Sa√≠da (-)</option>
                                <option value="receita">Entrada (+)</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Categoria</label>
                            <select id="cat">
                                <option value="Alimenta√ß√£o">üç¥ Alimenta√ß√£o</option>
                                <option value="Moradia">üè† Moradia</option>
                                <option value="Contas">üìÑ Contas</option>
                                <option value="Transporte">üöó Transporte</option>
                                <option value="Uber">üöñ Uber</option>
                                <option value="Lazer">üé° Lazer</option>
                                <option value="Sa√∫de">üè• Sa√∫de</option>
                                <option value="Investimento">üìà Investimento</option>
                                <option value="Bonus">üéÅ B√¥nus</option>
                                <option value="Outros">üì¶ Outros</option>
                            </select>
                        </div>
                        <div class="input-group"><label>Data</label><input type="date" id="data" required></div>
                        <button type="submit" class="btn" id="btn-save">Salvar na Nuvem</button>
                    </form>
                </div>
            </section>

            <section id="reports" class="tab">
                <h3>Relat√≥rios</h3><br>
                
                <div class="filter-container">
                    <div><span style="font-size:10px;">De:</span><input type="date" id="f-start" onchange="updateUI()"></div>
                    <div><span style="font-size:10px;">At√©:</span><input type="date" id="f-end" onchange="updateUI()"></div>
                </div>

                <div class="card" style="margin-bottom:15px;">
                    <span>Fluxo de Caixa (Sa√≠das vs Entradas)</span>
                    <canvas id="chartFluxo" height="200"></canvas>
                </div>

                <div class="grid">
                    <div class="card"><span>Ganhos (%)</span><canvas id="chartGanhos"></canvas></div>
                    <div class="card"><span>Gastos (%)</span><canvas id="chartGastos"></canvas></div>
                </div>
                
                <button onclick="exportarPDF()" class="btn" style="background:#475569; margin-top:15px;"><i class="fas fa-file-pdf"></i> Gerar Relat√≥rio PDF</button>
            </section>

        </main>

        <nav class="nav-bar">
            <button class="nav-item active" onclick="switchTab('home', this)"><i class="fas fa-home"></i>In√≠cio</button>
            <button class="nav-item" onclick="switchTab('add', this)"><i class="fas fa-plus-circle" style="font-size:30px; color:var(--primary)"></i>Novo</button>
            <button class="nav-item" onclick="switchTab('reports', this)"><i class="fas fa-chart-pie"></i>Relat√≥rio</button>
        </nav>
    </div>

    <script>
        // SUAS CHAVES (Mantidas do seu c√≥digo anterior)
        const firebaseConfig = {
            apiKey: "AIzaSyAP1tmLggzgyOtDeXu3MEtFXCVI5GJGPPk",
            authDomain: "financeiro-f5b93.firebaseapp.com",
            databaseURL: "https://financeiro-f5b93-default-rtdb.firebaseio.com",
            projectId: "financeiro-f5b93",
            storageBucket: "financeiro-f5b93.firebasestorage.app",
            messagingSenderId: "1006424381126",
            appId: "1:1006424381126:web:dfd6893d0991a5013aa9c7"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database().ref('finance_data');

        let dataList = [];
        let charts = {};

        function switchTab(tabId, btn) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            btn.classList.add('active');
            if(tabId !== 'add') {
                document.getElementById('finance-form').reset();
                document.getElementById('edit-id').value = '';
                document.getElementById('btn-save').innerText = 'Salvar na Nuvem';
                document.getElementById('form-title').innerText = 'Novo Lan√ßamento';
                // Reset data para hoje no form se mudar de aba
                document.getElementById('data').valueAsDate = new Date();
            }
        }

        document.getElementById('finance-form').onsubmit = (e) => {
            e.preventDefault();
            const editId = document.getElementById('edit-id').value;
            const id = editId || Date.now();
            const payload = {
                id,
                desc: document.getElementById('desc').value,
                valor: parseFloat(document.getElementById('valor').value),
                tipo: document.getElementById('tipo').value,
                cat: document.getElementById('cat').value,
                data: document.getElementById('data').value
            };
            db.child(id).set(payload);
            switchTab('home', document.querySelector('.nav-item'));
        };

        db.on('value', (s) => {
            dataList = s.val() ? Object.values(s.val()) : [];
            updateUI();
        });

        function updateUI() {
            // Pega os valores do filtro (j√° definidos no window.onload)
            const start = document.getElementById('f-start').value;
            const end = document.getElementById('f-end').value;
            
            let filtered = dataList;
            if(start && end) {
                filtered = dataList.filter(i => i.data >= start && i.data <= end);
            }

            let r = 0, d = 0;
            const list = document.getElementById('lista-transacoes');
            const metrics = document.getElementById('metrics-container');
            list.innerHTML = '';
            metrics.innerHTML = '';

            const cats = {}; // Para calcular %
            filtered.sort((a,b) => new Date(b.data) - new Date(a.data)).forEach(item => {
                if(item.tipo === 'receita') {
                    r += item.valor; 
                } else {
                    d += item.valor;
                    cats[item.cat] = (cats[item.cat] || 0) + item.valor;
                }
                
                // Normaliza classe CSS para categorias com acentos
                const catClass = 'cat-' + item.cat.toLowerCase()
                    .normalize("NFD").replace(/[\u0300-\u036f]/g, "");

                list.innerHTML += `
                    <div class="card" style="display:flex; align-items:center; margin-bottom:10px; padding:12px;">
                        <div style="flex:1">
                            <div style="font-weight:500">${item.desc}</div>
                            <div class="cat-tag ${catClass}">${item.cat}</div>
                        </div>
                        <div style="text-align:right">
                            <div style="font-weight:600; color:${item.tipo==='receita'?'#10b981':'#f43f5e'}">
                                ${item.tipo==='receita'?'+':'-'}R$ ${item.valor.toFixed(2)}
                            </div>
                            <div style="margin-top:5px; color:#64748b;">
                                <i class="fas fa-edit" onclick="editar('${item.id}')" style="margin-right:10px;"></i>
                                <i class="fas fa-trash" onclick="deletar('${item.id}')"></i>
                            </div>
                        </div>
                    </div>
                `;
            });

            document.getElementById('bal-total').innerText = `R$ ${(r-d).toFixed(2)}`;
            document.getElementById('bal-rec').innerText = `R$ ${r.toFixed(2)}`;
            document.getElementById('bal-des').innerText = `R$ ${d.toFixed(2)}`;
            document.getElementById('score-val').innerText = r > 0 ? Math.max(0, Math.round(100 - (d/r * 100))) : 0;

            // Render Metrics (%)
            Object.keys(cats).forEach(c => {
                const perc = ((cats[c] / d) * 100).toFixed(1);
                metrics.innerHTML += `
                    <div class="metric-item">
                        <span style="width:80px">${c}</span>
                        <div class="metric-bar"><div class="metric-fill" style="width:${perc}%"></div></div>
                        <span>${perc}%</span>
                    </div>
                `;
            });

            renderCharts(filtered);
        }

        function editar(id) {
            const item = dataList.find(i => i.id == id);
            document.getElementById('edit-id').value = item.id;
            document.getElementById('desc').value = item.desc;
            document.getElementById('valor').value = item.valor;
            document.getElementById('tipo').value = item.tipo;
            document.getElementById('cat').value = item.cat;
            document.getElementById('data').value = item.data;
            document.getElementById('btn-save').innerText = 'Atualizar';
            document.getElementById('form-title').innerText = 'Editar Lan√ßamento';
            switchTab('add', document.querySelectorAll('.nav-item')[1]);
        }

        function deletar(id) { if(confirm("Apagar?")) db.child(id).remove(); }

        function renderCharts(dados) {
            // Chart Fluxo
            const ctxF = document.getElementById('chartFluxo').getContext('2d');
            if(charts.fluxo) charts.fluxo.destroy();
            charts.fluxo = new Chart(ctxF, {
                type: 'bar',
                data: {
                    labels: ['Balan√ßo do Per√≠odo'],
                    datasets: [
                        { label: 'Entradas', data: [dados.filter(i=>i.tipo==='receita').reduce((a,b)=>a+b.valor,0)], backgroundColor: '#10b981', borderRadius: 10 },
                        { label: 'Sa√≠das', data: [dados.filter(i=>i.tipo==='despesa').reduce((a,b)=>a+b.valor,0)], backgroundColor: '#f43f5e', borderRadius: 10 }
                    ]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });

            // Pie Charts (Ganhos e Gastos)
            const renderPie = (canvasId, type) => {
                const ctx = document.getElementById(canvasId).getContext('2d');
                const cData = {};
                dados.filter(i => i.tipo === type).forEach(i => cData[i.cat] = (cData[i.cat] || 0) + i.valor);
                
                if(charts[canvasId]) charts[canvasId].destroy();
                
                charts[canvasId] = new Chart(ctx, {
                    type: 'doughnut',
                    data: { 
                        labels: Object.keys(cData), 
                        datasets: [{ 
                            data: Object.values(cData), 
                            // Cores expandidas para as novas categorias
                            backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ec4899', '#8b5cf6', '#ef4444', '#94a3b8', '#facc15', '#cbd5e1'] 
                        }] 
                    },
                    options: { plugins: { legend: { display: false } }, cutout: '70%' }
                });
            };
            
            // Renderiza ambos os gr√°ficos de rosca
            renderPie('chartGanhos', 'receita');
            renderPie('chartGastos', 'despesa');
        }

        async function exportarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("Relat√≥rio Financeiro Familiar", 14, 15);
            const rows = dataList.map(i => [i.data, i.desc, i.cat, i.tipo === 'receita' ? '+' + i.valor : '-' + i.valor]);
            doc.autoTable({ head: [['Data', 'Item', 'Categoria', 'Valor']], body: rows, startY: 25 });
            doc.save("relatorio_financas.pdf");
        }

        // --- FILTRO AUTOM√ÅTICO (Dia 1 at√© Hoje) ---
        window.onload = () => {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            
            document.getElementById('data').valueAsDate = today; // Data padr√£o no form
            
            // Define o filtro visualmente
            document.getElementById('f-start').value = firstDay.toISOString().split('T')[0];
            document.getElementById('f-end').value = today.toISOString().split('T')[0];
            
            // Nota: O updateUI ser√° chamado automaticamente quando o Firebase carregar os dados
        };
    </script>
</body>
</html>
